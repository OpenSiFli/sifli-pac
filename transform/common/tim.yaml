transforms:
  # Special cases: ATIM.CCxIE, CCxIF, they are not linearly distributed. So we use Cursed mode
  - !MakeFieldArray
      fieldsets: atim::regs::.*
      from: cc\d+(ie|if)
      to: cc$1
      mode: Cursed
  
  - !MakeFieldArray
      fieldsets: .*tim::regs::.*
      from: (ois|cc|ic|oc)\d+(\w*)
      to: $1$2

  - !MakeRegisterArray
      blocks: .*tim::.*tim
      from: ccr\d+
      to: ccr
      mode: Cursed
  - !RenameFields
      fieldset: .*tim::regs::Ccr\d+
      from: ccr\d+
      to: ccr
  - !MergeFieldsets
      from: atim::regs::Ccr\d+
      to: atim::regs::Ccr
  - !MergeFieldsets
      from: gptim::regs::Ccr\d+
      to: gptim::regs::Ccr

  - !Add
      ir:
        # --- CR1 ---
        enum/tim_common::vals::URS:
          bit_size: 1
          variants:
          - name: AnyEvent
            description: Any of counter overflow/underflow, setting UG, or update through slave mode, generates an update interrupt or DMA request
            value: 0
          - name: CounterOnly
            description: Only counter overflow/underflow generates an update interrupt or DMA request
            value: 1
        enum/tim_common::vals::CMS:
          bit_size: 2
          variants:
          - name: EdgeAligned
            description: The counter counts up or down depending on the direction bit
            value: 0
          - name: CenterAligned1
            description: The counter counts up and down alternatively. Output compare interrupt flags are set only when the counter is counting down.
            value: 1
          - name: CenterAligned2
            description: The counter counts up and down alternatively. Output compare interrupt flags are set only when the counter is counting up.
            value: 2
          - name: CenterAligned3
            description: The counter counts up and down alternatively. Output compare interrupt flags are set both when the counter is counting up or down.
            value: 3
        enum/tim_common::vals::DIR:
          bit_size: 1
          variants:
          - name: Up
            description: Counter used as upcounter
            value: 0
          - name: Down
            description: Counter used as downcounter
            value: 1
        # --- CR2 ---
        enum/tim_common::vals::CCDS:
          bit_size: 1
          variants:
          - name: OnCompare
            description: CCx DMA request sent when CCx event occurs
            value: 0
          - name: OnUpdate
            description: CCx DMA request sent when update event occurs
            value: 1
        enum/tim_common::vals::MMS:
          bit_size: 3
          variants:
          - name: Reset
            description: The UG bit from the TIMx_EGR register is used as trigger output
            value: 0
          - name: Enable
            description: The counter enable signal, CNT_EN, is used as trigger output
            value: 1
          - name: Update
            description: The update event is selected as trigger output
            value: 2
          - name: ComparePulse
            description: The trigger output send a positive pulse when the CC1IF flag it to be set, as soon as a capture or a compare match occurred
            value: 3
          - name: CompareOC1
            description: OC1REF signal is used as trigger output
            value: 4
          - name: CompareOC2
            description: OC2REF signal is used as trigger output
            value: 5
          - name: CompareOC3
            description: OC3REF signal is used as trigger output
            value: 6
          - name: CompareOC4
            description: OC4REF signal is used as trigger output
            value: 7
        enum/tim_common::vals::TI1S:
          bit_size: 1
          variants:
          - name: Normal
            description: The TIMx_CH1 pin is connected to TI1 input
            value: 0
          - name: XOR
            description: The TIMx_CH1, CH2, CH3 pins are connected to TI1 input
            value: 1
        # --- SMCR ---
        enum/tim_common::vals::ETP:
          bit_size: 1
          variants:
          - name: NotInverted
            description: ETR is noninverted, active at high level or rising edge
            value: 0
          - name: Inverted
            description: ETR is inverted, active at low level or falling edge
            value: 1
        enum/tim_common::vals::ETPS:
          bit_size: 2
          variants:
          - name: Div1
            description: Prescaler OFF
            value: 0
          - name: Div2
            description: ETRP frequency divided by 2
            value: 1
          - name: Div4
            description: ETRP frequency divided by 4
            value: 2
          - name: Div8
            description: ETRP frequency divided by 8
            value: 3
        enum/tim_common::vals::ETF:
          bit_size: 4
          variants:
          - name: NoFilter
            description: No filter, sampling is done at fDTS
            value: 0
          - name: FCK_INT_N2
            description: fSAMPLING=fCK_INT, N=2
            value: 1
          - name: FCK_INT_N4
            description: fSAMPLING=fCK_INT, N=4
            value: 2
          - name: FCK_INT_N8
            description: fSAMPLING=fCK_INT, N=8
            value: 3
          - name: FDTS_Div2_N6
            description: fSAMPLING=fDTS/2, N=6
            value: 4
          - name: FDTS_Div2_N8
            description: fSAMPLING=fDTS/2, N=8
            value: 5
          - name: FDTS_Div4_N6
            description: fSAMPLING=fDTS/4, N=6
            value: 6
          - name: FDTS_Div4_N8
            description: fSAMPLING=fDTS/4, N=8
            value: 7
          - name: FDTS_Div8_N6
            description: fSAMPLING=fDTS/8, N=6
            value: 8
          - name: FDTS_Div8_N8
            description: fSAMPLING=fDTS/8, N=8
            value: 9
          - name: FDTS_Div16_N5
            description: fSAMPLING=fDTS/16, N=5
            value: 10
          - name: FDTS_Div16_N6
            description: fSAMPLING=fDTS/16, N=6
            value: 11
          - name: FDTS_Div16_N8
            description: fSAMPLING=fDTS/16, N=8
            value: 12
          - name: FDTS_Div32_N5
            description: fSAMPLING=fDTS/32, N=5
            value: 13
          - name: FDTS_Div32_N6
            description: fSAMPLING=fDTS/32, N=6
            value: 14
          - name: FDTS_Div32_N8
            description: fSAMPLING=fDTS/32, N=8
            value: 15
        enum/tim_common::vals::MSM:
          bit_size: 1
          variants:
          - name: NoSync
            description: No action
            value: 0
          - name: Sync
            description: The effect of an event on the trigger input (TRGI) is delayed to allow a perfect synchronization between the current timer and its slaves (through TRGO). It is useful if we want to synchronize several timers on a single external event.
            value: 1
        enum/tim_common::vals::SMS:
          bit_size: 4
          variants:
          - name: Disabled
            description: Slave mode disabled - if CEN = '1' then the prescaler is clocked directly by the internal clock.
            value: 0
          - name: Encoder_Mode_1
            description: Encoder mode 1 - Counter counts up/down on TI2FP1 edge depending on TI1FP2 level.
            value: 1
          - name: Encoder_Mode_2
            description: Encoder mode 2 - Counter counts up/down on TI1FP2 edge depending on TI2FP1 level.
            value: 2
          - name: Encoder_Mode_3
            description: Encoder mode 3 - Counter counts up/down on both TI1FP1 and TI2FP2 edges depending on the level of the other input.
            value: 3
          - name: Reset_Mode
            description: Reset Mode - Rising edge of the selected trigger input (TRGI) reinitializes the counter and generates an update of the registers.
            value: 4
          - name: Gated_Mode
            description: Gated Mode - The counter clock is enabled when the trigger input (TRGI) is high. The counter stops (but is not reset) as soon as the trigger becomes low. Both start and stop of the counter are controlled.
            value: 5
          - name: Trigger_Mode
            description: Trigger Mode - The counter starts at a rising edge of the trigger TRGI (but it is not reset). Only the start of the counter is controlled.
            value: 6
          - name: Ext_Clock_Mode
            description: External Clock Mode 1 - Rising edges of the selected trigger (TRGI) clock the counter.
            value: 7
          - name: Combined_Reset_Trigger
            description: Rising edge of the selected trigger input (tim_trgi) reinitializes the counter, generates an update of the registers and starts the counter.
            value: 8
        enum/tim_common::vals::TS:
          bit_size: 5
          variants:
          - name: ITR0
            description: Internal Trigger 0
            value: 0
          - name: ITR1
            description: Internal Trigger 1
            value: 1
          - name: ITR2
            description: Internal Trigger 2
            value: 2
          - name: ITR3
            description: Internal Trigger 3
            value: 3
          - name: TI1F_ED
            description: TI1 Edge Detector
            value: 4
          - name: TI1FP1
            description: Filtered Timer Input 1
            value: 5
          - name: TI2FP2
            description: Filtered Timer Input 2
            value: 6
          - name: ETRF
            description: External Trigger input
            value: 7
  
  - !ModifyFieldsEnum
      fieldset: (\w+)tim::regs::Cr1
      field: urs
      enum: tim_common::vals::URS

  - !ModifyFieldsEnum
      fieldset: (\w+)tim::regs::Cr1
      field: cms
      enum: tim_common::vals::CMS

  - !ModifyFieldsEnum
      fieldset: (\w+)tim::regs::Cr1
      field: dir
      enum: tim_common::vals::DIR

  - !ModifyFieldsEnum
    fieldset: (\w+)tim::regs::Cr2
    field: ccds
    enum: tim_common::vals::CCDS

  - !ModifyFieldsEnum
      fieldset: (\w+)tim::regs::Cr2
      field: mms
      enum: tim_common::vals::MMS

  - !ModifyFieldsEnum
      fieldset: (\w+)tim::regs::Cr2
      field: ti1s
      enum: tim_common::vals::TI1S

  - !ModifyFieldsEnum
    fieldset: (\w+)tim::regs::Smcr
    field: etp
    enum: tim_common::vals::ETP

  - !ModifyFieldsEnum
      fieldset: (\w+)tim::regs::Smcr
      field: etps
      enum: tim_common::vals::ETPS

  - !ModifyFieldsEnum
      fieldset: (\w+)tim::regs::Smcr
      field: etf
      enum: tim_common::vals::ETF

  - !ModifyFieldsEnum
      fieldset: (\w+)tim::regs::Smcr
      field: msm
      enum: tim_common::vals::MSM

  - !ModifyFieldsEnum
      fieldset: (\w+)tim::regs::Smcr
      field: sms
      enum: tim_common::vals::SMS

  - !ModifyFieldsEnum
      fieldset: (\w+)tim::regs::Smcr
      field: ts
      enum: tim_common::vals::TS